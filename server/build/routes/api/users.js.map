{"version":3,"file":"users.js","names":["_express","require","_multer","_interopRequireDefault","_path","_requireJwtAuth","_refreshAccessToken","_User","_interopRequireWildcard","_getRequireWildcardCache","e","WeakMap","r","t","__esModule","default","has","get","n","__proto__","a","Object","defineProperty","getOwnPropertyDescriptor","u","prototype","hasOwnProperty","call","i","set","obj","router","Router","storage","multer","diskStorage","destination","req","file","cb","resolve","__dirname","filename","fileName","originalname","toLowerCase","split","join","Date","now","upload","fileFilter","mimetype","Error","put","requireJwtAuth","single","res","next","tempUser","User","findById","params","id","status","json","message","user","role","error","validateUser","body","details","avatarPath","password","provider","hashPassword","existingUser","findOne","username","updatedUser","avatar","name","calendarId","dueDateWeight","difficultyWeight","typeWeight","keys","forEach","k","undefined","findByIdAndUpdate","$set","new","err","console","me","toJSON","refreshTokenMiddleware","refreshToken","accessToken","response","fetch","headers","Authorization","data","items","calendarData","map","item","summary","final","calendars","users","find","sort","createdAt","m","_default","exports"],"sources":["../../../src/routes/api/users.js"],"sourcesContent":["import { Router } from 'express';\nimport multer from 'multer';\nimport { resolve } from 'path';\n\nimport requireJwtAuth from '../../middleware/requireJwtAuth';\nimport refreshTokenMiddleware from '../../middleware/refreshAccessToken';\nimport User, { hashPassword, validateUser } from '../../models/User';\n\nconst router = Router();\n\n// integrate set setCalendarId, setWeights into route\n// all calendars can be fetched elsewhere\n\nconst storage = multer.diskStorage({\n  destination: function (req, file, cb) {\n    cb(null, resolve(__dirname, '../../../public/images'));\n  },\n  filename: function (req, file, cb) {\n    const fileName = file.originalname.toLowerCase().split(' ').join('-');\n    cb(null, `avatar-${Date.now()}-${fileName}`);\n  },\n});\n\nconst upload = multer({\n  storage: storage,\n  fileFilter: (req, file, cb) => {\n    if (file.mimetype == 'image/png' || file.mimetype == 'image/jpg' || file.mimetype == 'image/jpeg') {\n      cb(null, true);\n    } else {\n      cb(null, false);\n      return cb(new Error('Only .png, .jpg and .jpeg format allowed!'));\n    }\n  },\n});\n\n//`checkit`, which is probably the option I'd suggest if  `validatem`\n\nrouter.put('/:id', [requireJwtAuth, upload.single('avatar')], async (req, res, next) => {\n  try {\n    const tempUser = await User.findById(req.params.id);\n    if (!tempUser) return res.status(404).json({ message: 'No such user.' });\n    if (!(tempUser.id === req.user.id || req.user.role === 'ADMIN'))\n      return res.status(400).json({ message: 'You do not have privileges to edit this user.' });\n\n    //validate name, username and password\n    const { error } = validateUser(req.body);\n    if (error) return res.status(400).json({ message: error.details[0].message });\n\n    let avatarPath = null;\n    if (req.file) {\n      avatarPath = req.file.filename;\n    }\n\n    // if fb or google user provider dont update password\n    let password = null;\n    if (req.user.provider === 'email' && req.body.password && req.body.password !== '') {\n      password = await hashPassword(req.body.password);\n    }\n\n    const existingUser = await User.findOne({ username: req.body.username });\n    if (existingUser && existingUser.id !== tempUser.id) {\n      return res.status(400).json({ message: 'Username already taken.' });\n    }\n\n    const updatedUser = {\n      avatar: avatarPath,\n      name: req.body.name,\n      username: req.body.username,\n      password,\n      calendarId: req.body.calendarId,\n      dueDateWeight: req.body.dueDateWeight,\n      difficultyWeight: req.body.difficultyWeight,\n      typeWeight: req.body.typeWeight,\n    };\n    // remove '', null, undefined\n    Object.keys(updatedUser).forEach((k) => !updatedUser[k] && updatedUser[k] !== undefined && delete updatedUser[k]);\n    // console.log(req.body, updatedUser);\n\n    const user = await User.findByIdAndUpdate(tempUser.id, { $set: updatedUser }, { new: true });\n\n    res.status(200).json({ user });\n  } catch (err) {\n    console.error(err);\n    res.status(500).json({ message: 'Something went wrong.' });\n  }\n});\n\n// router.get('/reseed', async (req, res) => {\n//   await seedDb();\n//   res.json({ message: 'Database reseeded successfully.' });\n// });\n\nrouter.get('/me', requireJwtAuth, (req, res) => {\n  const me = req.user.toJSON();\n  res.json({ me });\n});\n\nrouter.get('/:username', requireJwtAuth, refreshTokenMiddleware, async (req, res) => {\n  try {\n    const user = await User.findOne({ username: req.params.username });\n    if (!user) return res.status(404).json({ message: 'No user found.' });\n    user.refreshToken = undefined;\n    user.accessToken = undefined;\n\n    const response = await fetch('https://www.googleapis.com/calendar/v3/users/me/calendarList', {\n      headers: {\n        Authorization: `Bearer ${req.user.accessToken}`,\n      },\n    });\n    const data = await response.json();\n    const items = data.items;\n    const calendarData = items.map((item) => {\n      return {\n        id: item.id,\n        summary: item.summary,\n      };\n    });\n\n    const final = user.toJSON();\n    // add calendar data\n    final.calendars = calendarData;\n\n    // res.json({ user: user.toJSON() });\n    res.json({ user: final });\n  } catch (err) {\n    res.status(500).json({ message: 'Something went wrong.' });\n  }\n});\n\nrouter.get('/', requireJwtAuth, async (req, res) => {\n  // verify user is admin\n  if (req.user.role !== 'ADMIN') return res.status(400).json({ message: 'You are not admin.' });\n  try {\n    const users = await User.find().sort({ createdAt: 'desc' });\n\n    res.json({\n      users: users.map((m) => {\n        return m.toJSON();\n      }),\n    });\n  } catch (err) {\n    res.status(500).json({ message: 'Something went wrong.' });\n  }\n});\n\n// router.delete('/:id', requireJwtAuth, async (req, res) => {\n//   try {\n//     const tempUser = await User.findById(req.params.id);\n//     if (!tempUser) return res.status(404).json({ message: 'No such user.' });\n//     if (!(tempUser.id === req.user.id || req.user.role === 'ADMIN'))\n//       return res.status(400).json({ message: 'You do not have privilegies to delete that user.' });\n\n//     // if (['email0@email.com', 'email1@email.com'].includes(tempUser.email))\n//     //   return res.status(400).json({ message: 'You can not delete seeded user.' });\n\n//     //delete all messages from that user\n//     await Message.deleteMany({ user: tempUser.id });\n//     //delete user\n//     const user = await User.findByIdAndRemove(tempUser.id);\n//     res.status(200).json({ user });\n//   } catch (err) {\n//     res.status(500).json({ message: 'Something went wrong.' });\n//   }\n// });\n\nexport default router;\n\n// FIX THIS\n/*\n\n\n// Set calendar ID\nconst setCalendarId = async (req, res) => {\n  const { calendarId } = req.body;\n  try {\n    const user = await User.findOne({ _id: req.user._id });\n    if (!user) {\n      return res.status(404).json({ message: \"User not found\" });\n    }\n    user.calendarId = calendarId;\n    await user.save();\n    res.json({ message: \"Calendar ID updated\" }); // Send the response here\n  } catch (error) {\n    console.error(error);\n    res.status(500).json({ message: \"Internal Server Error\" }); // Handle errors and send appropriate responses\n  }\n};\n\nconst getWeights = async (req, res) => {\n  // Get weights from user object\n  const user = await User.findOne({ _id: req.user._id });\n  if (!user) {\n    return res.status(404).json({ message: \"User not found\" });\n  }\n  const { dueDateWeight, difficultyWeight, typeWeight } = user;\n  return res.json({ dueDateWeight, difficultyWeight, typeWeight });\n};\n\nconst setWeights = async (req, res) => {\n  // Set all weights in user object\n  const user = await User.findOne({ _id: req.user._id });\n  if (!user) {\n    return res.status(404).json({ message: \"User not found\" });\n  }\n  user.dueDateWeight = req.body.dueDateWeight;\n  user.difficultyWeight = req.body.difficultyWeight;\n  user.typeWeight = req.body.typeWeight;\n  await user.save();\n  return res.json({ message: \"Weights updated\" });\n};\n\nmodule.exports = {\n  getUserSimple,\n  setCalendarId,\n  getWeights,\n  setDueDateWeight,\n  setDifficultyWeight,\n  setTypeWeight,\n  setWeights,\n};\n\n*/\n"],"mappings":"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AAC,CAAC;EAC7F,IAAI;IACF,MAAM+C,KAAK,GAAG,MAAMrD,aAAI,CAACsD,IAAI,CAAC,CAAC,CAACC,IAAI,CAAC;MAAEC,SAAS,EAAE;IAAO,CAAC,CAAC;IAE3D3D,GAAG,CAACQ,IAAI,CAAC;MACPgD,KAAK,EAAEA,KAAK,CAACL,GAAG,CAAES,CAAC,IAAK;QACtB,OAAOA,CAAC,CAACpB,MAAM,CAAC,CAAC;MACnB,CAAC;IACH,CAAC,CAAC;EACJ,CAAC,CAAC,OAAOH,GAAG,EAAE;IACZrC,GAAG,CAACO,MAAM,CAAC,GAAG,CAAC,CAACC,IAAI,CAAC;MAAEC,OAAO,EAAE;IAAwB,CAAC,CAAC;EAC5D;AACF,CAAC,CAAC;;AAEF;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA,IAAAoD,QAAA,GAAAC,OAAA,CAAAxG,OAAA,GAEegB,MAAM,EAErB;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA"}